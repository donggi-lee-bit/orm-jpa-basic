# 양방향 매핑

## 테이블 연관관계와 양방향 객체 연관관계의 차이

- 테이블의 연관관계는 방향이라는 개념이 없다
  - 테이블은 FK 하나로 양쪽 테이블을 참조할 수 있다
- 객체는 연관관계가 있는 객체를 각각 넣어줘야 참조할 수 있다
- 객체는 단방향 두 개로 양방향을 구현

## 연관관계의 주인

객체를 양방향 매핑하기 위해서는 연관관계를 맺고자하는 두 개의 객체가 각각 단방향 매핑을 해주어야한다.
A, B 객체 중 어느 객체를 불러와 값을 수정해야할지 알 수 없다.
이 떄 연관관계 주인을 지정하여 주인만이 외래 키를 관리하도록 한다.

### 양방향 매핑 규칙

1. 객체의 두 관계중 하나를 연관관계 주인으로 지정
2. **연관관계의 주인만 외래 키를 관리 (등록, 수정)**
3. **주인이 아닌 쪽은 읽기만 가능**
4. 주인은 `mappedBy` 속성 사용 X
5. 주인이 아니면 `mappedBy` 속성으로 주인을 지정

### 누구를 주인으로

- 외래 키가 있는 곳을 주인으로 정한다
  - db 입장에서 외래키가 있는 곳이 다(일대다의 그 '다')다.
  - 다 쪽이 `ManyToOne`

## 양방향 매핑시 주의할 점

- 연관관계의 주인에 값을 입력하지 않음
  - 가짜 매핑한 객체를 통해 값을 넣으려고 하면 실제로 들어가지 않음

## 객체 관계를 고려하면 양쪽 다 값을 입력해야 한다.

- 순수 객체 상태를 고려하여 항상 양쪽에 값을 설정한다
- 양쪽 다 일일히 넣어주려고 하면 실수가 발생할 수 있기 때문에
  - 연관관계 편의 메서드를 생성한다. ex) 연관관계 주인에 값을 설정해줄 때 메서드를 통해 나머지 객체에도 값을 추가해주도록 한다.
- 양방향 매핑시 무한 루프 조심
  - toString(), lombok, Json 생성 라이브러리
  - json 생성 라이브러리 해결 방안 : controller 에서 entity 를 반환하지 않는다. entity 변경 시 api 스펙이 바뀔 수 있기 때문. dto 로 변환해서 반환

## 정리

- 단방향 매핑만으로도 연관관계 매핑은 완료됨
  - 초반 설계 시 단방향 매핑으로 설계를 끝내야한다 (1:N의 N쪽에 외래키의 주인으로 단방향 연관관계 매핑을 한다)
  - 양방향 매핑은 필요할 때 추가한다 (테이블에 영향을 주지 않기 때문)
